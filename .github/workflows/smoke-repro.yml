name: Reproducible Smoke-Run

on:
  pull_request:
    paths:
      - 'train.py'
      - 'run_repro.sh'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'repro_dataset/**'
      - '.github/workflows/smoke-repro.yml'

concurrency:
  group: smoke-run-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  smoke-cpu:
    name: Smoke-run (CPU, hosted)
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.run-smoke.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          required=(train.py run_repro.sh requirements.txt repro_dataset)
          missing=()
          for f in "${required[@]}"; do
            if [ ! -e "$f" ]; then
              missing+=("$f")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required files: ${missing[*]}"
            exit 2
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: Make run script executable
        run: chmod +x ./run_repro.sh

      - name: Run reproducible smoke-run (CPU)
        id: run-smoke
        env:
          # on hosted runner we may not have GPUs; run_repro.sh uses model_name_or_path; we expect small model or CPU fallback
          RUN_MODE: cpu
        run: |
          set -euo pipefail
          ./run_repro.sh || exit $?

      - name: Upload reproducibility artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-repro-artifacts
          path: |
            repro_output/
            repro_output/*

  smoke-gpu-docker:
    name: Smoke-run (GPU, docker on self-hosted)
    runs-on: [self-hosted, gpu]
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          required=(Dockerfile run_repro.sh train.py requirements.txt repro_dataset)
          missing=()
          for f in "${required[@]}"; do
            if [ ! -e "$f" ]; then
              missing+=("$f")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required files: ${missing[*]}"
            exit 2
          fi

      - name: Build Docker image
        run: |
          IMAGE_TAG="mltune:repro-${{ github.sha::8 }}"
          docker build --build-arg CUDA_BASE=${{ env.CUDA_BASE || 'nvidia/cuda:12.2.0-devel-ubuntu22.04' }} -t $IMAGE_TAG .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Run smoke-run container
        id: run-docker
        run: |
          set -euo pipefail
          IMAGE_TAG=${IMAGE_TAG}
          # Mount workspace and run smoke script in container
          docker run --gpus all --rm -v "${PWD}:/workspace" -w /workspace $IMAGE_TAG ./run_repro.sh

      - name: Collect artifacts from workspace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-repro-artifacts-docker
          path: |
            repro_output/
            repro_output/*

  gate:
    name: Gate PR on smoke-run
    runs-on: ubuntu-latest
    needs: [smoke-cpu]
    steps:
      - name: Check smoke-run result
        run: |
          # The CPU job is the canonical PR gate in hosted CI.
          # If the smoke-cpu job failed, this job will not run; keep this as a simple reporter.
          echo "Smoke-run completed for PR. Check uploaded artifacts in Actions tab if needed."
