# Production Grafana Configuration for Medical AI Assistant
# Healthcare-compliant dashboards and data sources

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: medical-ai-production
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-server:9090
      isDefault: true
      jsonData:
        timeInterval: 15s
        queryTimeout: 60s
        httpMethod: POST
      editable: true

    - name: Loki
      type: loki
      access: proxy
      url: http://loki:3100
      jsonData:
        maxLines: 1000
        derivedFields:
          - datasourceUid: 'prometheus'
            matcherRegex: 'trace_id=(\\w+)'
            name: 'TraceID'
            url: '$${__value.raw}'

    - name: Jaeger
      type: jaeger
      access: proxy
      url: http://jaeger-query:16686
      jsonData:
        tracesToLogs:
          datasourceUid: 'loki'
          tags: ['job', 'instance', 'pod', 'namespace']
          mappedTags: [{ key: 'service.name', value: 'service' }]
          mapTagNamesEnabled: false
          spanStartTimeShift: '1h'
          spanEndTimeShift: '1h'
          filterByTraceID: false
          filterBySpanID: false

    - name: Medical AI Database
      type: postgres
      access: proxy
      url: postgresql-cluster-service:5432
      database: medical_ai
      user: grafana_reader
      secureJsonData:
        password: "${GRAFANA_DB_PASSWORD}"
      jsonData:
        sslmode: 'require'
        maxOpenConns: 0
        maxIdleConns: 2
        connMaxLifetime: 14400

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: medical-ai-production
  labels:
    grafana_dashboard: "1"
data:
  medical-ai-compliance-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Medical AI Compliance Dashboard",
        "tags": ["healthcare", "hipaa", "fda", "compliance"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-24h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "HIPAA Compliance Status",
            "type": "stat",
            "targets": [
              {
                "expr": "hipaa_compliance_score",
                "legendFormat": "HIPAA Score"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 80},
                    {"color": "green", "value": 95}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "FDA Model Compliance",
            "type": "stat",
            "targets": [
              {
                "expr": "fda_model_compliance_score",
                "legendFormat": "FDA Score"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 85},
                    {"color": "green", "value": 95}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "PHI Access Violations",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(hipaa_unauthorized_access_attempts_total[5m])",
                "legendFormat": "Unauthorized Access Rate"
              }
            ],
            "yAxes": [
              {
                "label": "Events/min",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Data Integrity Checks",
            "type": "table",
            "targets": [
              {
                "expr": "data_integrity_check_status",
                "format": "table",
                "instant": true
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ]
      }
    }

  medical-ai-performance-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Medical AI Performance Dashboard",
        "tags": ["healthcare", "performance", "ml"],
        "timezone": "browser",
        "refresh": "15s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Model Inference Latency",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(model_inference_duration_seconds_bucket[5m]))",
                "legendFormat": "P50 Latency"
              },
              {
                "expr": "histogram_quantile(0.95, rate(model_inference_duration_seconds_bucket[5m]))",
                "legendFormat": "P95 Latency"
              },
              {
                "expr": "histogram_quantile(0.99, rate(model_inference_duration_seconds_bucket[5m]))",
                "legendFormat": "P99 Latency"
              }
            ],
            "yAxes": [
              {
                "label": "Latency (seconds)",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Model Accuracy Score",
            "type": "graph",
            "targets": [
              {
                "expr": "model_accuracy_score",
                "legendFormat": "Current Accuracy"
              }
            ],
            "yAxes": [
              {
                "label": "Accuracy",
                "min": 0,
                "max": 1
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Request Volume",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(medical_ai_requests_total[5m])",
                "legendFormat": "{{service}}"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "GPU Utilization",
            "type": "graph",
            "targets": [
              {
                "expr": "nvidia_gpu_utilization_percent",
                "legendFormat": "GPU {{gpu}}"
              }
            ],
            "yAxes": [
              {
                "label": "Utilization %",
                "min": 0,
                "max": 100
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ]
      }
    }

  medical-ai-security-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Medical AI Security Dashboard",
        "tags": ["healthcare", "security", "monitoring"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-6h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Security Events",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(security_events_total[5m])",
                "legendFormat": "{{event_type}}"
              }
            ],
            "yAxes": [
              {
                "label": "Events/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Failed Authentication Attempts",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(authentication_failures_total[5m])",
                "legendFormat": "{{service}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 3,
            "title": "Network Traffic Anomalies",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(network_anomalies_total[5m])",
                "legendFormat": "{{anomaly_type}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          }
        ]
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: medical-ai-production
data:
  grafana.ini: |
    [server]
    protocol = http
    http_addr = 0.0.0.0
    http_port = 3000
    domain = grafana.medical-ai.com
    root_url = https://grafana.medical-ai.com/
    serve_from_sub_path = false
    enable_gzip = true
    tls_min_version = "1.3"

    [database]
    type = postgres
    host = postgresql-cluster-service:5432
    name = grafana
    user = grafana
    password = ${GRAFANA_DB_PASSWORD}
    ssl_mode = require
    max_open_conns = 100
    max_idle_conns = 100
    conn_max_lifetime = 14400

    [session]
    provider = database
    cookie_name = grafana_sess
    cookie_secure = true
    session_life_time = 86400
    conn_max_lifetime = 14400

    [dataproxy]
    logging = false
    timeout = 30
    dialTimeout = 30
    keep_alive = 30
    tls_handshake_timeout = 10
    expect_continue_timeout = 1

    [analytics]
    reporting_enabled = false
    check_for_updates = false

    [security]
    admin_user = admin
    admin_password = ${GRAFANA_ADMIN_PASSWORD}
    allow_sign_up = false
    cookie_secure = true
    cookie_samesite = strict
    disable_gravatar = true
    data_source_proxy_whitelist = prometheus-server,postgresql-cluster-service,redis-cluster-service

    [smtp]
    enabled = true
    host = smtp.medical-ai.com:587
    user = grafana@medical-ai.com
    password = ${SMTP_PASSWORD}
    from_address = grafana@medical-ai.com
    from_name = Medical AI Grafana
    ehlo_identity = grafana.medical-ai.com
    startTLS_policy = MandatoryStartTLS

    [alerting]
    enabled = true
    execute_alerts = true
    error_or_timeout = alerting
    nodata_or_nullvalues = no_data

    [unified_alerting]
    enabled = true
    disabled_orgs = []
    admin_config_poll_interval = 60s
    alertmanager_config_poll_interval = 60s
    ha_listen_address = "0.0.0.0:9094"
    ha_advertise_address = ""
    ha_peers = ""
    ha_peer_timeout = "15s"
    ha_gossip_interval = "200ms"
    ha_push_pull_interval = "60s"

    [feature_toggles]
    enable = ngalert

    [date_formats]
    full_date = MMM Do, YYYY
    interval_second = HH:mm:ss
    interval_minute = HH:mm
    interval_hour = MM/DD HH:mm
    interval_day = MM/DD
    interval_month = YYYY-MM
    interval_year = YYYY

    [log]
    mode = console file
    level = info
    format = text

    [log.file]
    path = /var/log/grafana/grafana.log
    max_lines = 1000000
    max_size_shift = 28
    daily_rotate = true
    max_days = 7

    [paths]
    data = /var/lib/grafana/
    temp_data_lifetime = 24h
    logs = /var/log/grafana
    plugins = /var/lib/grafana/plugins
    provisioning = /etc/grafana/provisioning

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: medical-ai-production
  labels:
    app: grafana
    component: monitoring
    environment: production
    compliance: hipaa,fda,iso27001
spec:
  replicas: 2
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
        component: monitoring
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: grafana-service-account
      securityContext:
        runAsNonRoot: true
        runAsUser: 472
        runAsGroup: 472
        fsGroup: 472
      containers:
      - name: grafana
        image: grafana/grafana:10.2.0
        ports:
        - containerPort: 3000
          name: http
          protocol: TCP
        - containerPort: 9090
          name: gossip
          protocol: TCP
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secrets
              key: admin-password
        - name: GF_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secrets
              key: database-password
        - name: GF_SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secrets
              key: smtp-password
        - name: GF_USERS_ALLOW_SIGN_UP
          value: "false"
        - name: GF_INSTALL_PLUGINS
          value: "grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel"
        - name: GF_RENDERING_SERVER_URL
          value: "http://grafana-rendering:8081/render"
        - name: GF_RENDERING_CALLBACK_URL
          value: "http://grafana:3000/"
        - name: GF_LOG_FILTERS
          value: "rendering:debug"
        resources:
          requests:
            cpu: "200m"
            memory: "512Mi"
          limits:
            cpu: "1"
            memory: "2Gi"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop: [ALL]
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        volumeMounts:
        - name: grafana-pv
          mountPath: /var/lib/grafana
        - name: grafana-config
          mountPath: /etc/grafana/grafana.ini
          subPath: grafana.ini
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards
          mountPath: /etc/grafana/provisioning/dashboards
        - name: tmp
          mountPath: /tmp
        - name: plugins
          mountPath: /var/lib/grafana/plugins
      - name: grafana-renderer
        image: grafana/grafana-image-renderer:3.8.0
        ports:
        - containerPort: 8081
          name: renderer
          protocol: TCP
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: [ALL]
      volumes:
      - name: grafana-pv
        persistentVolumeClaim:
          claimName: grafana-pvc
      - name: grafana-config
        configMap:
          name: grafana-config
      - name: grafana-datasources
        configMap:
          name: grafana-datasources
      - name: grafana-dashboards
        configMap:
          name: grafana-dashboards
      - name: tmp
        emptyDir: {}
      - name: plugins
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: grafana-service
  namespace: medical-ai-production
  labels:
    app: grafana
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-east-1:ACCOUNT:certificate/CERT-ID"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
spec:
  type: LoadBalancer
  ports:
  - port: 443
    targetPort: 3000
    protocol: TCP
    name: https
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http
  selector:
    app: grafana
  sessionAffinity: ClientIP
