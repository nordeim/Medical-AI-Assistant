# Production Security Configuration
# Healthcare-compliant security with WAF, DDoS protection, and network isolation

# AWS WAF Configuration for Medical AI
apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-waf-config
  namespace: medical-ai-production
data:
  waf-rules.yaml: |
    # AWS WAF Web ACL for Medical AI Production
    # HIPAA, FDA, and ISO 27001 compliant security rules
    
    apiVersion: aws.wafv2.aws.crossplane.io/v1alpha1
    kind: WebACL
    metadata:
      name: medical-ai-production-waf
      namespace: medical-ai-production
    spec:
      providerConfigRef:
        name: production
      forProvider:
        scope: CLOUDFRONT
        defaultAction:
          allow: {}
        rules:
        # Rate Limiting Rule (HIPAA PHI Protection)
        - name: rate-limit-rule
          priority: 1
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: rate-limit-rule
          rateBasedStatement:
            limit: 2000
            aggregateKeyType: IP
            scopeDownStatement:
              geoMatchStatement:
                countryCodes:
                - US
                - CA
              byteMatchStatement:
                searchString: "/api/v1/patient"
                fieldToMatch:
                  header:
                    name: ":path"
                textTransformations:
                - priority: 0
                  type: NONE
                positionalConstraint: EXACTLY
              limit: 100  # Lower limit for patient data access
        
        # SQL Injection Protection
        - name: sql-injection-rule
          priority: 2
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: sql-injection-rule
          andStatement:
            statements:
            - sqlInjectionMatchStatement:
                fieldToMatch:
                  body:
                    oversizeHandling: CONTINUE
                textTransformations:
                - priority: 0
                  type: NONE
            - geoMatchStatement:
                countryCodes:
                - US
                - CA
        
        # XSS Protection
        - name: xss-protection-rule
          priority: 3
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: xss-protection-rule
          xssMatchStatement:
            fieldToMatch:
              body:
                oversizeHandling: CONTINUE
              headers:
                matchPattern:
                  allHeaders: {}
                fieldToMatch:
                  headerNames:
                  - X-Requested-With
            textTransformations:
            - priority: 0
              type: NONE
        
        # Medical Data Access Control
        - name: medical-data-access-rule
          priority: 4
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: medical-data-access-rule
          andStatement:
            statements:
            - byteMatchStatement:
                searchString: "/api/v1/phi/"
                fieldToMatch:
                  header:
                    name: ":path"
                textTransformations:
                - priority: 0
                  type: NONE
                positionalConstraint: PREFIX
            - notStatement:
                statement:
                  byteMatchStatement:
                    searchString: "Bearer"
                    fieldToMatch:
                      header:
                        name: Authorization
                    textTransformations:
                    - priority: 0
                      type: NONE
                    positionalConstraint: CONTAINS
        
        # Bot Protection for Medical AI
        - name: bot-protection-rule
          priority: 5
          action:
            challenge: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: bot-protection-rule
          managedRuleGroupStatement:
            vendorName: AWS
            name: AWSManagedRulesCommonRuleSet
            excludedRules:
            - SizeRestrictions_BODY
            - UnknownMethodOptions_BODY
            - HTTPMethodValidation_BODY
            --application-XSS_Tag
        
        # Geolocation Restriction (US/CA only for PHI)
        - name: geolocation-rule
          priority: 6
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: geolocation-rule
          geoMatchStatement:
            countryCodes:
            - US
            - CA
            - GB
            - DE
            - AU  # Limited international access for medical AI
        
        # Custom Medical AI API Rules
        - name: medical-api-rule
          priority: 7
          allow: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: medical-api-rule
          orStatement:
            statements:
            - byteMatchStatement:
                searchString: "/api/v1/health"
                fieldToMatch:
                  header:
                    name: ":path"
                textTransformations:
                - priority: 0
                  type: NONE
                positionalConstraint: PREFIX
            - byteMatchStatement:
                searchString: "/api/v1/compliance"
                fieldToMatch:
                  header:
                    name: ":path"
                textTransformations:
                - priority: 0
                  type: NONE
                positionalConstraint: PREFIX
            - byteMatchStatement:
                searchString: "/api/v1/model/"
                fieldToMatch:
                  header:
                    name: ":path"
                textTransformations:
                - priority: 0
                  type: NONE
                positionalConstraint: PREFIX
        
        # IP Whitelist for Healthcare Networks
        - name: healthcare-ip-whitelist
          priority: 100
          allow: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: healthcare-ip-whitelist
          geoMatchStatement:
            countryCodes:
            - US
            - CA
          ipSetReferenceStatement:
            arn: "arn:aws:wafv2:us-east-1:ACCOUNT:regional/ipset/healthcare-networks"
        
        # Default Deny Rule
        - name: default-deny-rule
          priority: 200
          action:
            block: {}
          visibilityConfig:
            sampledRequestsEnabled: true
            cloudWatchMetricsEnabled: true
            metricName: default-deny-rule
          geoMatchStatement:
            countryCodes:
            - US
            - CA
        
        visibilityConfig:
          sampledRequestsEnabled: true
          cloudWatchMetricsEnabled: true
          metricName: medical-ai-production-waf

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflare-security-config
  namespace: medical-ai-production
data:
  cloudflare-waf.yaml: |
    # Cloudflare Security Configuration for Medical AI
    # Enterprise-level security with healthcare compliance
    
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: cloudflare-security-config
    data:
      security-rules.json: |
        {
          "security_rules": {
            "rulesets": [
              {
                "name": "Medical AI Core Security Rules",
                "id": "core-security-rules",
                "description": "Core security rules for Medical AI production environment",
                "phases": {
                  "http_ratelimit": {
                    "rules": [
                      {
                        "id": "rate-limit-medical-api",
                        "expression": "(http.request.uri.path matches \"^/api/v1/.*\")",
                        "action": {
                          "rate_limit": {
                            "characteristics": ["ip.src"],
                            "period": 60,
                            "requests": 1000,
                            "mitigation_timeout": 300
                          }
                        }
                      },
                      {
                        "id": "rate-limit-patient-data",
                        "expression": "(http.request.uri.path matches \"^/api/v1/phi/.*\")",
                        "action": {
                          "rate_limit": {
                            "characteristics": ["ip.src"],
                            "period": 60,
                            "requests": 100,
                            "mitigation_timeout": 900
                          }
                        }
                      }
                    ]
                  },
                  "http_firewall_custom": {
                    "rules": [
                      {
                        "id": "sql-injection-protection",
                        "expression": "(http.request.body contains \"union\" and http.request.body contains \"select\") or (http.request.uri.query contains \"' or 1=1\")",
                        "action": {
                          "block": {
                            "response": {
                              "status_code": 403,
                              "status_text": "Forbidden",
                              "content_type": "application/json",
                              "body": "{\"error\": \"Invalid request\", \"compliance\": \"HIPAA\"}"
                            }
                          }
                        }
                      },
                      {
                        "id": "xss-protection",
                        "expression": "(http.request.body contains \"<script>\") or (http.request.uri.query contains \"javascript:\")",
                        "action": {
                          "block": {
                            "response": {
                              "status_code": 400,
                              "status_text": "Bad Request",
                              "content_type": "application/json",
                              "body": "{\"error\": \"XSS detected\", \"compliance\": \"HIPAA\"}"
                            }
                          }
                        }
                      },
                      {
                        "id": "phi-access-control",
                        "expression": "(http.request.uri.path matches \"^/api/v1/phi/.*\" and not cf.threat_score < 1)",
                        "action": {
                          "challenge": {
                            "mode": "managed_challenge"
                          }
                        }
                      },
                      {
                        "id": "healthcare-network-only",
                        "expression": "(not ip.geoip.country in {\"US\" \"CA\" \"GB\" \"DE\" \"AU\"})",
                        "action": {
                          "block": {
                            "response": {
                              "status_code": 403,
                              "status_text": "Forbidden",
                              "content_type": "application/json",
                              "body": "{\"error\": \"Access restricted to authorized regions\", \"compliance\": \"HIPAA\"}"
                            }
                          }
                        }
                      }
                    ]
                  },
                  "http_request_firewall_custom": {
                    "rules": [
                      {
                        "id": "security-headers",
                        "expression": "true",
                        "action": {
                          "response_headers": {
                            "headers": [
                              {
                                "header_name": "X-Frame-Options",
                                "header_value": "DENY"
                              },
                              {
                                "header_name": "X-Content-Type-Options",
                                "header_value": "nosniff"
                              },
                              {
                                "header_name": "X-XSS-Protection",
                                "header_value": "1; mode=block"
                              },
                              {
                                "header_name": "Strict-Transport-Security",
                                "header_value": "max-age=31536000; includeSubDomains; preload"
                              },
                              {
                                "header_name": "Content-Security-Policy",
                                "header_value": "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' wss: https:; frame-ancestors 'none';"
                              },
                              {
                                "header_name": "Referrer-Policy",
                                "header_value": "strict-origin-when-cross-origin"
                              },
                              {
                                "header_name": "Permissions-Policy",
                                "header_value": "geolocation=(), microphone=(), camera=()"
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                }
              }
            ],
            "bot_fight_mode": true,
            "ddos_protection": {
              "always_on": true,
              "sensitivity": "medium",
              "health_check": true
            },
            "ssl_tls": {
              "min_tls_version": "1.3",
              "max_tls_version": "1.3",
              "ciphers": [
                "ECDHE-RSA-AES128-GCM-SHA256",
                "ECDHE-RSA-AES256-GCM-SHA384",
                "ECDHE-RSA-CHACHA20-POLY1305"
              ],
              "early_hints": true,
              "automatic_https_rewrites": true,
              "tls_client_auth": "optional"
            }
          }
        }

---
# Network Isolation and Security Policies
apiVersion: v1
kind: ConfigMap
metadata:
  name: network-security-policies
  namespace: medical-ai-production
data:
  network-policies.yaml: |
    # Kubernetes Network Policies for Medical AI Production
    # HIPAA-compliant network segmentation and isolation
    
    # Deny all ingress traffic by default
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: default-deny-all-ingress
      namespace: medical-ai-production
      labels:
        policy: security
        compliance: hipaa
    spec:
      podSelector: {}
      policyTypes:
      - Ingress
    ---
    # Deny all egress traffic by default
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: default-deny-all-egress
      namespace: medical-ai-production
      labels:
        policy: security
        compliance: hipaa
    spec:
      podSelector: {}
      policyTypes:
      - Egress
    
    # Frontend ingress rules (HTTP/HTTPS only)
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: frontend-ingress
      namespace: medical-ai-production
      labels:
        app: medical-ai-frontend
        compliance: hipaa
    spec:
      podSelector:
        matchLabels:
          app: medical-ai-frontend
      policyTypes:
      - Ingress
      ingress:
      - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              name: istio-system
        ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
    
    # Backend network policy
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: backend-network-policy
      namespace: medical-ai-production
      labels:
        app: medical-ai-backend
        compliance: hipaa,fda
    spec:
      podSelector:
        matchLabels:
          app: medical-ai-backend
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              app: medical-ai-frontend
        - podSelector:
            matchLabels:
              app: medical-ai-model-serving
        ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 8080
      egress:
      - to:
        - podSelector:
            matchLabels:
              app: postgresql
        ports:
        - protocol: TCP
          port: 5432
      - to:
        - podSelector:
            matchLabels:
              app: redis
        ports:
        - protocol: TCP
          port: 6379
      - to:
        - podSelector:
            matchLabels:
              app: prometheus
        ports:
        - protocol: TCP
          port: 9090
      - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
        - protocol: UDP
          port: 123
    
    # Model serving network policy
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: model-serving-network-policy
      namespace: medical-ai-production
      labels:
        app: medical-ai-model-serving
        compliance: fda
    spec:
      podSelector:
        matchLabels:
          app: medical-ai-model-serving
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              app: medical-ai-backend
        ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 9090
      egress:
      - to:
        - podSelector:
            matchLabels:
              app: postgresql
        ports:
        - protocol: TCP
          port: 5432
      - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    
    # Database network policy (most restrictive)
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: postgresql-network-policy
      namespace: medical-ai-production
      labels:
        app: postgresql
        tier: primary
        compliance: hipaa,fda
    spec:
      podSelector:
        matchLabels:
          app: postgresql
          tier: primary
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              app: medical-ai-backend
        - podSelector:
            matchLabels:
              app: prometheus
        - namespaceSelector:
            matchLabels:
              name: monitoring
        ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 9187
      egress:
      - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    
    # Redis network policy
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: redis-network-policy
      namespace: medical-ai-production
      labels:
        app: redis
        compliance: hipaa
    spec:
      podSelector:
        matchLabels:
          app: redis
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              app: medical-ai-backend
        - podSelector:
            matchLabels:
              app: medical-ai-frontend
        - namespaceSelector:
            matchLabels:
              name: monitoring
        ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 9121
      egress:
      - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    
    # Monitoring network policy
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: monitoring-network-policy
      namespace: medical-ai-production
      labels:
        app: prometheus
        compliance: hipaa,fda
    spec:
      podSelector:
        matchLabels:
          app: prometheus
      policyTypes:
      - Ingress
      - Egress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              app: medical-ai-backend
        - podSelector:
            matchLabels:
              app: medical-ai-frontend
        - podSelector:
            matchLabels:
              app: medical-ai-model-serving
        - podSelector:
            matchLabels:
              app: postgresql
        - podSelector:
            matchLabels:
              app: redis
        - namespaceSelector:
            matchLabels:
              name: monitoring
        ports:
        - protocol: TCP
          port: 9090
      egress:
      - to:
        - namespaceSelector: {}
        ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8080
      - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53

---
# Pod Security Standards and Policies
apiVersion: v1
kind: ConfigMap
metadata:
  name: pod-security-policies
  namespace: medical-ai-production
data:
  pod-security-policy.yaml: |
    # Pod Security Policy for Medical AI Production
    # Enforces security standards for healthcare compliance
    
    apiVersion: policy/v1beta1
    kind: PodSecurityPolicy
    metadata:
      name: medical-ai-psp
      labels:
        app: medical-ai
        compliance: hipaa,fda,iso27001
    spec:
      # Privileged settings - most restrictive
      privileged: false
      allowPrivilegeEscalation: false
      requiredDropCapabilities:
        - ALL
      volumes:
        - 'configMap'
        - 'emptyDir'
        - 'projected'
        - 'secret'
        - 'persistentVolumeClaim'
      hostNetwork: false
      hostIPC: false
      hostPID: false
      # Run as non-root user
      runAsUser:
        rule: 'MustRunAsNonRoot'
      # SELinux options
      seLinux:
        rule: 'RunAsAny'
      # Filesystem group
      fsGroup:
        rule: 'MustRunAs'
        ranges:
          - min: 1
            max: 65535
      # Read-only root filesystem
      readOnlyRootFilesystem: true
      # Supplemental groups
      supplementalGroups:
        rule: 'MustRunAs'
        ranges:
          - min: 1
            max: 65535
      
    ---
    # Restricted pod security policy for databases
    apiVersion: policy/v1beta1
    kind: PodSecurityPolicy
    metadata:
      name: medical-ai-database-psp
      labels:
        app: postgresql
        tier: database
        compliance: hipaa
    spec:
      privileged: false
      allowPrivilegeEscalation: false
      requiredDropCapabilities:
        - ALL
      volumes:
        - 'configMap'
        - 'emptyDir'
        - 'projected'
        - 'secret'
        - 'persistentVolumeClaim'
      hostNetwork: false
      hostIPC: false
      hostPID: false
      runAsUser:
        rule: 'MustRunAsNonRoot'
        ranges:
          - min: 999
            max: 999
      seLinux:
        rule: 'RunAsAny'
      fsGroup:
        rule: 'MustRunAs'
        ranges:
          - min: 999
            max: 999
      readOnlyRootFilesystem: false  # Databases need write access
      supplementalGroups:
        rule: 'MustRunAs'
        ranges:
          - min: 999
            max: 999

---
# Security Service Accounts and RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: medical-ai-production
  name: security-audit-role
rules:
- apiGroups: [""]
  resources: ["events", "pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]
- apiGroups: ["audit.k8s.io"]
  resources: ["events"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: security-audit-rolebinding
  namespace: medical-ai-production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: security-audit-role
subjects:
- kind: ServiceAccount
  name: security-audit-sa
  namespace: medical-ai-production

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: security-audit-sa
  namespace: medical-ai-production
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/security-audit-role

---
# Security Monitoring and Alerting
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-monitoring-config
  namespace: medical-ai-production
data:
  security-rules.yml: |
    groups:
    - name: security.events
      interval: 30s
      rules:
      - alert: SecurityEventDetected
        expr: rate(security_events_total[5m]) > 0
        for: 0s
        labels:
          severity: critical
          compliance: hipaa
        annotations:
          summary: "Security event detected"
          description: "{{ $value }} security events detected in the last 5 minutes"
          action_required: "immediate_investigation"
      
      - alert: UnauthorizedAccessAttempt
        expr: rate(unauthorized_access_attempts_total[5m]) > 0
        for: 0s
        labels:
          severity: critical
          compliance: hipaa
          security_type: "unauthorized_access"
        annotations:
          summary: "Unauthorized access attempt detected"
          description: "{{ $value }} unauthorized access attempts detected"
          action_required: "security_incident_response"
      
      - alert: PHIAccessViolation
        expr: rate(phi_access_violations_total[5m]) > 0
        for: 0s
        labels:
          severity: critical
          compliance: hipaa
          data_classification: "phi"
        annotations:
          summary: "PHI access violation detected"
          description: "PHI access violations detected: {{ $value }} events"
          escalation_policy: "hipaa_immediate"

    - name: compliance.events
      interval: 60s
      rules:
      - alert: ComplianceFrameworkViolation
        expr: compliance_framework_violations_total > 0
        for: 0s
        labels:
          severity: critical
          compliance: hipaa,fda,iso27001
        annotations:
          summary: "Compliance framework violation"
          description: "Compliance violation detected: {{ $value }}"
          action_required: "compliance_review"
